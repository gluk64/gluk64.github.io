<!DOCTYPE html>
<html>
<head>
    <title>Plasma demo</title>
    <script src="vue.js"></script>

    <!-- <link rel="stylesheet" href="element.css">
    <script src="element.js"></script> -->
    
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>

    <script src="abi-decoder.js"></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/ethjs@0.3.4/dist/ethjs.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1">

</head>
<body>
    <div id="app">
        <el-container>
            <el-main>                          
                <el-row :gutter="10">
                    <el-col :xs="0" :sm="1" :md="2" :lg="4"><div class="empty"></div></el-col>
                    <el-col :xs="24" :sm="20" :md="18" :lg="16">
                        <div class="box">
                            <h1>Snarks are coming!</h1>
                            <el-tabs>
                                <el-tab-pane label="Wallet">

                                    <el-form ref="form" label-width="6em">
                                        <p>Username:</p>
                                        <el-input v-model="username" placeholder="Choose any login" ></el-input>
                                    </el-form>
                                    <div v-if="username">
                                        <br>
                                        <p>Account ID: <strong>{{account}}</strong></p>
                                        <p>Balance committed: <strong>{{balanceCommitted}}</strong></p>
                                        <p>Balance verified: <strong>{{balanceVerified}}</strong></p>
                                        <br>
                                        <p><el-button @click="transfer">Make transfer</el-button></p>
                                        <br>
                                        <div v-if="userTransactions.length">
                                            <h4>Latest transactions</h4>
                                            <tx-list :transactions=userTransactions></tx-list>
                                        </div>
                                    </div>

                                </el-tab-pane>
                                <el-tab-pane label="Block explorer">

                                    <p>Blocks committed: {{totalCommitted}}</p>
                                    <p>Blocks verified: {{totalVerified}}</p>
                                    <div v-if="transactions.length">
                                        <h4>All transactions</h4>
                                        <tx-list :transactions=transactionsExt></tx-list>
                                    </div>

                                </el-tab-pane>
                            </el-tabs>
                        </div>
                    </el-col>
                    <el-col :xs="0" :sm="1" :md="2" :lg="4"><div class="empty"></div></el-col>
                </el-row>                        
            </el-main>
        </el-container>

        <el-dialog
            title="New transfer"
            :visible.sync="showTransferDialog"
            width="90%">

            <el-form ref="form" label-width="6em">
                <el-form-item label="From:">
                    <el-input v-model="account" readonly ></el-input>
                </el-form-item>
                <el-form-item label="To:">
                    <el-input v-model="to" placeholder="Recepient's account ID" ></el-input>
                </el-form-item>
                <el-form-item label="Amount:">
                    <el-input v-model="amount" placeholder="Amount to send" ></el-input>
                </el-form-item>
            </el-form>

            <span slot="footer" class="dialog-footer">
                <el-button @click="showTransferDialog = false">Cancel</el-button>
                <el-button type="primary" @click="confirmTransfer">Confirm</el-button>
            </span>
        </el-dialog>

    </div>

    <style>
        html {
            font-family: "Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","微软雅黑",Arial,sans-serif;
            background: #f8f8f8;
        }
        .empty {
            padding: 2em;
        }
        .box {
            background: white;
            border: solid 1px;
            border-color: lightgrey;
            border-radius: 0.5em;
            padding: 2em;
        }
        .side {
            padding: 0.5em;
        }
        .merkle {
            font-size: 0.9em;
        }
    </style>

    <script type="x/template" id="tx-list">
        <el-table :data="transactions" style="width: 100%" class="merkle">
            <el-table-column prop="from" label="From"></el-table-column>
            <el-table-column prop="to" label="To"></el-table-column>
            <el-table-column prop="amount" label="Amount"></el-table-column>
            <el-table-column prop="block" label="Block #"></el-table-column>
            <el-table-column prop="status" label="Status"></el-table-column>
        </el-table>
    </script>

    <script>
        Vue.component('tx-list', {
            template: document.currentScript.ownerDocument.getElementById('tx-list'),
            props: ['transactions'],
            data: () => ({
            }),
            methods: {
            }
        })
    </script>

    <script>
        const eth = new Eth(new Eth.HttpProvider('https://rinkeby.infura.io'))
        const PlasmaABI = [{"constant":true,"inputs":[],"name":"lastVerifiedRoot","outputs":[{"name":"","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalCommitted","outputs":[{"name":"","type":"uint32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint32"}],"name":"blocks","outputs":[{"name":"circuit","type":"uint8"},{"name":"totalFees","type":"uint128"},{"name":"newRoot","type":"bytes32"},{"name":"finalHash","type":"bytes32"},{"name":"prover","type":"address"},{"name":"deadline","type":"uint32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"blockNumber","type":"uint32"},{"name":"proof","type":"uint256[8]"}],"name":"verifyBlock","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"balance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"blockNumber","type":"uint32"},{"name":"totalFees","type":"uint128"},{"name":"txDataPacked","type":"bytes"},{"name":"newRoot","type":"bytes32"}],"name":"commitBlock","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"blockNumber","type":"uint32"},{"name":"totalFees","type":"uint128"},{"name":"txDataPacked","type":"bytes"}],"name":"createPublicDataCommitment","outputs":[{"name":"h","type":"bytes32"}],"payable":false,"stateMutability":"pure","type":"function"},{"constant":true,"inputs":[],"name":"totalVerified","outputs":[{"name":"","type":"uint32"}],"payable":false,"stateMutability":"view","type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"name":"blockNumber","type":"uint32"}],"name":"BlockCommitted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"blockNumber","type":"uint32"}],"name":"BlockVerified","type":"event"}]
        const contractAddr = '0x03F96e57d5BcA7D3E571E96d651A409Ae47244d9'
        const TopicBlockCommitted = '0xdf39762be389bd636a9efb2e4f3b26ac7d22eda4f0840f389209987a09e50fc9'
        const APIserver = 'http://1be52733.ngrok.io/send'
        const EventBlockCommitted = PlasmaABI[9]
        const InitialBalance = 1000000

        plasma = eth.contract(PlasmaABI).at(contractAddr)
        abiDecoder.addABI(PlasmaABI)

        const reverseBits = function(n, len) {
            let bits = n.toString(2)
            bits = bits.padStart(len, "0").split("")
            return parseInt(bits.reverse().join(""), 2)
        }

        const unpack = function(n, man_len) {
            var bits = parseInt(n,16).toString(2)
            bits = bits.padStart(man_len+5, "0").split("")
            //console.log(bits.join(""))
            var exp = parseInt(bits.slice(0,5).reverse().join(""), 2)
            var mantissa = parseInt(bits.slice(5,bits.length).reverse().join(""), 2)
            let r = mantissa * Math.pow(10, exp)
            //console.log(r)
            return r
        }

        //3: from
        //3: to
        //2: amount
        //1: fee
        // 5 bit: exp
        // 11/3 bit: amount
        const decodeTx = function(tx) {
            //console.log('tx', tx)
            let from = reverseBits(parseInt(tx.substr(0,6), 16), 24)
            let to = reverseBits(parseInt(tx.substr(6,6), 16), 24)
            let amount = unpack(tx.substr(12,4), 11)
            let fee = unpack(tx.substr(16,2), 3)
            let r = {from, to, amount, fee}
            //console.log(r)
            return r
        }

        const decodeTxBatch = function(input) {
            return input.match(/.{1,18}/g).map(decodeTx)
        }

        window.app = new Vue({
            el: '#app',
            data: {
                updater: null,
                lastBlock: 3470091,

                totalCommitted: 0,
                totalVerified: 0,
                
                username: "alex",
                nonce: 0,
                loading: false,
                
                showTransferDialog: false,
                to: "",
                amount: "",

                transactions: []
            },
            async created() {
                this.updateChain()
                setInterval(this.updateChain, 1000)
            },
            computed: {
                account() {
                    return this.hash(this.username) % 100 // 2^24
                },
                balanceCommitted() {
                    return this.sum(this.totalCommitted)
                },
                balanceVerified() {
                    return this.sum(this.totalVerified)
                },
                transactionsExt() {
                    return this.transactions.map(_tx => {
                        let tx = JSON.parse(JSON.stringify(_tx))
                        tx.status = this.totalVerified >= tx.block ?
                            "✔ verified" : "committed"
                        return tx
                    }).reverse()
                },
                userTransactions() {
                    return this.transactionsExt.filter(tx => tx.from == this.account || tx.to == this.account)
                }
            },
            watch: {
                account() {
                    clearTimeout(this.updater)
                    this.loading = true
                    this.updater = setTimeout( () => {
                        this.updater = setTimeout( () => {
                            this.loading = false
                        }, 500 )
                    }, 500 )
                    window.u = this.updater
                },
                totalCommitted(_new, _old) {
                    if (_old > 0 && _new !== _old) {
                        this.$notify({
                            message: 'New block committed',
                            type: 'info'
                        }) 
                    }
                },
                totalVerified(_new, _old) {
                    if (_old > 0 && _new !== _old) {
                        this.$notify({
                            message: 'Block verified',
                            type: 'info'
                        }) 
                    }
                },
            },
            methods: {

                sum(untilBlock) {
                    let balance = InitialBalance
                    for(var i in this.transactions) {
                        let tx = this.transactions[i]
                        if( untilBlock + 1 > tx.block ) {
                            if(tx.from == this.account) balance -= tx.amount
                            if(tx.to == this.account) balance += tx.amount
                        } 
                    }
                    return balance
                },

                async updateChain() {
                    //console.log('checking for updates')
                    await this.fetchNewTransactions()
                    this.totalCommitted = (await plasma.totalCommitted())[0].words[0]
                    this.totalVerified = (await plasma.totalVerified())[0].words[0]
                }, 

                async fetchNewTransactions() {
                    let logs = await eth.getLogs({
                        address: contractAddr, 
                        fromBlock: this.lastBlock,
                        toBlock: "latest",
                        topics: [TopicBlockCommitted]
                    })
                    for(var i in logs) {
                        //let event = ethAbi.decodeEvent(EventBlockCommitted, logs[i].data)
                        let block = parseInt(logs[i].topics[1].substr(2), 16)
                        //console.log('committed block #', block)
                        let tx = await eth.getTransactionByHash(logs[i].transactionHash)
                        let txInput = abiDecoder.decodeMethod(tx.input)
                        this.lastBlock = tx.blockNumber.toNumber() + 1
                        let txs = decodeTxBatch(txInput.params[2].value.substr(2))
                        for(var j in txs) {
                            let tx = txs[j]
                            tx.block = block
                            this.transactions.push(tx)
                        }
                    }
                },

                async transfer() {
                    this.showTransferDialog = true
                },

                async confirmTransfer() {
                    this.showTransferDialog = false

                    let body = {from: this.account, to: parseInt(this.to), amount: parseInt(this.amount)}
                    //console.log('submit tx: ', body)
                    let response = await this.request(APIserver, "POST", body)

                    if(response.body.accepted) {
                        this.$notify({
                            message: 'Yay! Transaction accepted',
                            type: 'success'
                        })
                    } else {
                        this.$notify({
                            message: 'Oops! Transaction declined',
                            type: 'error'
                        })       
                    }
                    //console.log(response)
                },

                request(url, method, data) {
                    return new Promise(function(resolve,reject) {
                        var xhr = new XMLHttpRequest()
                        xhr.open(method || "POST", url)
                        xhr.setRequestHeader("Content-Type", "application/json")
                        xhr.onreadystatechange = function() {
                            if (xhr.readyState == 4) { // DONE
                                //console.log('got: ', xhr, xhr.readyState, xhr.status) // 202 for success
                                resolve({
                                    status: xhr.status,
                                    body: JSON.parse(xhr.response)
                                })
                            }
                        }
                        xhr.send(data ? JSON.stringify(data) : null)
                    })
                },

                hash(str, asString, seed) { // hashFnv32a
                    /*jshint bitwise:false */
                    var i, l,
                        hval = (seed === undefined) ? 0x811c9dc5 : seed;

                    for (i = 0, l = str.length; i < l; i++) {
                        hval ^= str.charCodeAt(i);
                        hval += (hval << 1) + (hval << 4) + (hval << 7) + (hval << 8) + (hval << 24);
                    }
                    if( asString ){
                        // Convert to 8 digit hex string
                        return ("0000000" + (hval >>> 0).toString(16)).substr(-8);
                    }
                    return hval >>> 0;
                },
            }
        })

    window.p = {
        // promise printer for debugging in console
        set p(promise) {
            console.log(promise)
            promise.then(r => console.log(r) )
        }
    }

    </script>
</body>
</html>
